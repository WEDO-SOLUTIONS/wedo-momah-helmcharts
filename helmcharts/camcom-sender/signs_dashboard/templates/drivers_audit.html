{% extends "navbar.html" %}

{% block title %}{{ _('Audit')}}{% endblock %}

{% block styles %}
    {{ super() }}
    <link id="bsdp-css" href="/static/bootstrap-datepicker3/1.9.0/bootstrap-datepicker3.min.css"
          rel="stylesheet">
    <link href="/static/select2/4.1/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/static/font-awesome/4.7.0/font-awesome.min.css">
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="/static/bootstrap-datepicker/1.9.0/bootstrap-datepicker.min.js"></script>
    <script src="/static/bootstrap-datepicker/1.9.0/bootstrap-datepicker.ru.min.js"
            charset="UTF-8"></script>
    <script src="/static/select2/4.1/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            document.getElementById('nav_audit').className = 'active';
            $("#projects_select").select2({
                multiple: true,
            });
            $("#interest_zone_region_selector").select2({
                multiple: true,
            });
        });
    </script>
{% endblock %}

{% block content %}
    <style>
        body {
            padding-top: 50px;
        }

        .starter-template {
            padding: 40px 15px;
            text-align: center;
        }

        .table {
            text-align: left;
        }

        .row {
            margin-bottom: 20px;
        }

        .row .row {
            margin-top: 10px;
            margin-bottom: 0;
        }
    </style>

    <div class="container">
        <div class="starter-template">
            <form>
                <div class="row">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon">Дата</span>
                            <select class="form-control" name="date_type">
                              <option value="uploaded" {% if query_params.date_type == 'uploaded' %}selected {% endif %}>Загрузки</option>
                              <option value="recorded" {% if query_params.date_type == 'recorded' %}selected {% endif %}>Съемки</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group date" data-provide="datepicker" data-date-format="dd-mm-yyyy">
                            <span class="input-group-addon">От</span>
                            <input name="from_date" type="text" class="form-control" value="{{ query_params.from_date }}">
                            <div class="input-group-addon">
                                <span class="glyphicon glyphicon-th"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-addon">{{ _('Polygon') }}</span>
                            <select class="form-control select2" id="interest_zone_region_selector" name="interest_zone_regions" size="1" multiple="multiple" style="width: 100%">
                                {% for region in search_regions %}
                                    <option
                                        value="{{ region.id }}"
                                        {%- if region.id in query_params.interest_zone_regions %} selected {% endif %}
                                        >{{ region.zone_name }}: {{ region.region_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2" style="text-align: left; vertical-align: center">
                        <div class="form-check">
                          <input
                              class="form-check-input"
                              name="only_in_projects"
                              type="checkbox"
                              value="1"
                              id="oip"
                              {% if query_params.only_in_projects %}checked{% endif %}
                          >
                          <label class="form-check-label" for="oip">
                             Только в проекте
                          </label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-addon">Тип &nbsp;</span>
                            <select class="form-control" name="track_type">
                              <option value="" {% if query_params.type == '' %}selected {% endif %}>Все</option>
                              <option value="mobile" {% if query_params.type == 'mobile' %}selected {% endif %}>Моб.приложение</option>
                              <option value="dashcam" {% if query_params.type == 'dashcam' %}selected {% endif %}>Видеорегистратор</option>
                              <option value="video_360" {% if query_params.type == 'video_360' %}selected {% endif %}>{{ _('Видео 360') }}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group date" data-provide="datepicker" data-date-format="dd-mm-yyyy">
                            <span class="input-group-addon">До</span>
                            <input name="to_date" type="text" class="form-control" value="{{ query_params.to_date }}">
                            <div class="input-group-addon">
                                <span class="glyphicon glyphicon-th"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <input name="email" type="text" class="form-control" placeholder="Email" value="{{ query_params.email }}">
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-default">Submit</button>
                    </div>
                </div>

            </form>
            <div class="row">
                <table class="table table-striped table-sm">
                    <tr>
                        <th>Дата</th>
                        <th>Email</th>
                        <th>Длина, км</th>
                        <th>Было знаков</th>
                        <th>Плотность знаков</th>
                        <th>Ошибки</th>
                        <th>Обработано</th>
                        <th>Полезные</th>
                        <th>КПД</th>
                        <th>Точность</th>
                    </tr>
                    {% for stat in drivers_stat %}
                        <tr>
                            <td>
                                {{ stat.date }}
                                <br/>
                                {{ stat.type }}
                            </td>
                            <td>{{ stat.email }}</td>
                            <td>
                                <a href="{{ url_for("tracks", **query_params.to_uri(email=stat.email, from_date=stat.date, to_date=stat.date)) }}">{{ stat.distance }}</a>
                            </td>
                            <td>
                                {% for key, value in stat.total_signs %}
                                    {{ key }}: {{ value }}<br />
                                {% endfor %}
                            </td>
                            <td>{{ stat.signs_density_before }} ({{ stat.signs_density }})</td>
                            <td>{{ stat.total_errors_count + stat.clarifications_count }}</td>
                            <td>{{ stat.resolved_errors_count + stat.resolved_clarifications_count }}</td>
                            <td>
                                {% for key, value in stat.total_good %}
                                    {{ key }}: {{ value }}<br />
                                {% endfor %}
                            </td>
                            <td>
                                {% if (stat.total_errors_count + stat.clarifications_count) > 0 and
                                    (stat.resolved_errors_count + stat.resolved_clarifications_count) / (stat.total_errors_count + stat.clarifications_count) > 0.75
                                %}
                                    {{ stat.kpd }}
                                {% endif %}
                            </td>
                            <td>
                                {% if (stat.total_errors_count + stat.clarifications_count) > 0 and
                                    (stat.resolved_errors_count + stat.resolved_clarifications_count) / (stat.total_errors_count + stat.clarifications_count) > 0.75
                                %}
                                    {{ stat.accuracy }}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            <div class="row">
                <a href="{{ url_for("drivers_download_kml", **query_params.to_uri()) }}">
                    <button class="glyphicon glyphicon-save-file"> Download KML</button>
                </a>
                <a href="{{ url_for("drivers_download_csv", **query_params.to_uri()) }}">
                    <button class="glyphicon glyphicon-save-file"> Download CSV</button>
                </a>
            </div>
        </div>
    </div>
{% endblock %}
