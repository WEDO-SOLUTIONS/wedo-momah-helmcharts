{% extends 'navbar.html' %}

{% block title %}{{ _('Фильтры') }}{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="/static/font-awesome/4.7.0/font-awesome.min.css">
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
      async function syncFiltersWithPro() {
        $('div.overlay').addClass('overlay-show');
        $('div.spanner').addClass('overlay-show');
        await $.ajax(
            {
                type: "POST",
                url: '{{ url_for('api_pro_sync_filters') }}',
                success: function (result){
                    console.log('Pro sync result:', result);
                    $('div.overlay').removeClass('overlay-show');
                    $('div.spanner').removeClass('overlay-show');
                    let sync_success = result.success;
                    if (sync_success) {
                        $('#pro_filters_sync_success').show();
                        $('#pro_filters_sync_fail').hide();
                    } else {
                        $('#pro_filters_sync_success').hide();
                        $('#pro_filters_sync_fail').show();
                    }
                    $('#proFiltersSyncModal').modal();
                },
                error: function () {
                    $('div.overlay').removeClass('overlay-show');
                    $('div.spanner').removeClass('overlay-show');
                    $('#pro_filters_sync_success').hide();
                    $('#pro_filters_sync_fail').show();
                    $('#proFiltersSyncModal').modal();
                },
            },
        );
      }
      $(document).ready(function() {
          document.getElementById('nav_pro').className = 'active';
      });

    </script>
{% endblock %}

{% block content %}
    <style>
        body {
            padding-top: 50px;
        }

        .starter-template {
            padding: 0 15px;
            text-align: center;
        }

        .table {
            text-align: left;
        }

        .row {
            margin-bottom: 20px;
        }

        .row .row {
            margin-top: 10px;
            margin-bottom: 0;
        }

        .spanner{
          position:absolute;
          top: 20%;
          left: 0;
          width: 100%;
          display:block;
          text-align:center;
          height: 300px;
          color: #FFF;
          transform: translateY(-20%);
          z-index: 10001;
          visibility: hidden;
        }
        .overlay{
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0px;
          z-index: 10000;
          background: rgba(0,0,0,0.5);
          visibility: hidden;
        }
        .overlay-show{
          visibility: visible;
        }
    </style>

    <div class="modal fade" id="proFiltersSyncModal" tabindex="-1" role="dialog" aria-labelledby="proFiltersSyncModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="proFiltersSyncModalLabel">{{ _('Синхронизация фильтров с PRO') }}</h5>
          </div>
          <div class="modal-body">
              <div>
                <p id="pro_filters_sync_success">{{ _('Фильтры успешно синхронизированы!') }}</p>
                <p id="pro_filters_sync_fail">{{ _('Произошла ошибка, фильтры не были синхронизированы!') }}</p>
              </div>
          </div>
          <div class="modal-footer">
              <button type="submit" class="btn btn-primary" data-dismiss="modal">{{ _('OK') }}</button>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay"></div>
    <div class="spanner">
        <p>{{ _('Синхронизируем фильтры с PRO..') }}</p>
    </div>

    <div class="container">
        <div class="starter-template">
            <div class="row">
                <h2>{{ _('Фильтры') }}</h2>
                <table class="table table-striped table-sm">
                <tr>
                    <td style="text-align: left">
                        <button
                            class="btn btn-danger"
                            type="button"
                            onclick="syncFiltersWithPro(); return false;"
                        >
                            {{ _('Синхронизировать фильтры с PRO') }}
                        </button>
                    </td>
                </tr>
            {% for asset, asset_filters in asset_to_filters.items() %}
                <tr>
                    <td style="text-align: right">
                        <button
                            class="btn collapsed"
                            type="button"
                            data-toggle="collapse"
                            data-target="#pro_{{ asset.kind }}_filters_json_collapse"
                            aria-expanded="false"
                            aria-controls="collapseExample_{{ asset.kind }}"
                        >
                            {{ _('Показать JSON-представление фильтров ассета %(asset_name)s (%(asset_kind)s)', asset_name=asset.name, asset_kind=asset.kind) }}
                            <span class="caret"></span>
                        </button>
                        <div class="collapse" id="pro_{{ asset.kind }}_filters_json_collapse" aria-expanded="false">
                            <div class="well" style="text-align: left">
                                <pre><code id="prepared_pro_{{ asset.kind }}_filters_update_request">{{ asset_filters }}</code></pre>
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
                </table>
            </div>
        </div>
    </div>
{% endblock %}
